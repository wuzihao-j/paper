<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.wzh.paper.dao.StockDAO">

    <select id="listStockInfo" resultType="StockInfo">
        select symbol, stock_name, last_trade, chg, stock_change, five_min_chg,
            volume, turnover, turnover_rate, swing, qrr, the_committee,
            peratio, stock_date
        from stock_info
        where 1=1
            <if test="startDate != null">
                and stock_date >= #{startDate}
            </if>
            <if test="endDate != null">
                and stock_date <![CDATA[<=]]> #{endDate}
            </if>
    </select>

    <select id="listStockByChart" resultType="StockInfo">
        select inf.last_trade, inf.stock_date
        from stock_name idx left join stock_info inf on idx.symbol = inf.symbol
        where idx.symbol = #{symbol}
    </select>

    <select id="listStockName" resultType="StockInfo">
        select concat(stock_name, '(', symbol, ')') value, symbol, stock_name
        from stock_name
        where 1=1 and stock_name  != ''
        <if test="keyword != null and keyword != ''">
            and symbol REGEXP #{keyword} or stock_name REGEXP #{keyword}
        </if>
        order by stock_name
        limit 0, 20
    </select>

    <select id="getSymbolLastInfo" resultType="StockInfo">
        select symbol, stock_name, chg, last_trade
        from stock_info
        where symbol = #{symbol}
        order by stock_date DESC
        limit 0, 1
    </select>

    <select id="existStock">
        select count(1) from user_stock_buy where symbol = #{symbol}
    </select>

    <insert id="buyStock">
        insert into user_stock_buy(user_id, symbol, count) values(#{userId}, #{symbol}, #{stockNum})
        on duplicate key update count = count + #{stockNum}
    </insert>

    <insert id="attentionStock">
        insert into user_stock_follow(user_id, symbol) values(#{userId}, #{symbol})
        on duplicate key update status = 1
    </insert>

    <select id="isAttention" resultType="integer">
        select status from user_stock_follow where symbol = #{symbol} and user_id = #{userId}
    </select>

    <update id="cancenAttention">
        update user_stock_follow set status = 0 where user_id = #{userId} and symbol = #{symbol}
    </update>

    <select id="listAttentionStockSelect" resultType="StockInfo">
        SELECT
            info.stock_name,
            info.last_trade,
            info.chg,
            info.volume,
            info.turnover,
            info.turnover_rate,
            info.swing,
            info.qrr,
            info.the_committee,
            info.peratio
        FROM
            stock_info info
        LEFT JOIN user_stock_follow fo ON info.symbol = fo.symbol
        WHERE
            fo.status = 1
        AND fo.user_id = #{userId}
        ORDER BY
            info.stock_date
        LIMIT 0, (select count(1) from user_stock_follow where user_id = #{userId} and status = 1)
    </select>
</mapper>